(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[17],{258:function(t,e,r){"use strict";r.r(e);var a=r(555);var i=r(367);for(var n in i)if(["default"].indexOf(n)<0)(function(t){r.d(e,t,(function(){return i[t]}))})(n);var s=r(495);var o=r(2);var l=Object(o["a"])(i["default"],a["a"],a["b"],false,null,"1a01a4ca",null);e["default"]=l.exports},367:function(t,e,r){"use strict";r.r(e);var a=r(368);var i=r.n(a);for(var n in a)if(["default"].indexOf(n)<0)(function(t){r.d(e,t,(function(){return a[t]}))})(n);e["default"]=i.a},368:function(t,e,r){"use strict";var a=r(1);Object.defineProperty(e,"__esModule",{value:true});e.default=void 0;var i=a(r(5));var n=a(r(6));var s=a(r(17));var o=a(r(318));var l=a(r(338));var u=a(r(305));var p=a(r(272));var d=a(r(342));var c=a(r(346));var f=a(r(277));var h=a(r(347));var b=r(9);var m=r(494);var g=a(r(281));var v=r(273);function _(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);if(e)a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}));r.push.apply(r,a)}return r}function y(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};if(e%2){_(Object(r),true).forEach((function(e){(0,s.default)(t,e,r[e])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(t,Object.getOwnPropertyDescriptors(r))}else{_(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}}return t}var w={name:"cloud-manager-setup",components:{SetupTable:o.default,InstallMethod:l.default,RightPanel:u.default,Tips:p.default,FilterIpTips:d.default,FilterDialog:h.default},mixins:[c.default,f.default],props:{id:{type:[Number,String],required:true},innerIp:{type:String,default:""},type:{type:String,default:"create",validator:function t(e){return["create","replace"].includes(e)}},replaceHostId:{type:Number,default:0}},data:function t(){return{isManual:false,formData:{},net:{list:[{name:this.$t("简单网络"),id:"simple"},{name:this.$t("复杂网络"),id:"complex"}],active:"simple"},rules:{osType:[{required:true,message:this.$t("必填项"),trigger:"blur"}],port:[{required:true,message:this.$t("必填项"),trigger:"blur"},{message:this.$t("端口范围",{range:"0-65535"}),trigger:"blur",validator:function t(e){var r=/^([0-9]|[1-9]\d{1,3}|[1-5]\d{4}|6[0-4]\d{4}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])$/;return r.test(e)}}],account:[{required:true,message:this.$t("必填项"),trigger:"blur"}],bkBizId:[{required:true,message:this.$t("必填项"),trigger:"blur"}]},setupConfig:{header:m.setupInfo,data:[]},showRightPanel:false,innerIps:"",tips:this.$t("安装要求提示"),topTips:[this.$t("替换Proxy提示一"),this.$t("替换Proxy提示二")],loadingSetup:false,apId:0,marginLeft:108,cloudName:""}},computed:y(y({},(0,b.mapGetters)("cloud",["apList","apUrl"])),{},{saveBtnText:function t(){var e={create:this.$t("安装"),replace:this.$t("替换")};return e[this.type]},hostList:function t(){var e=this;return this.setupConfig.data.map((function(t){return{bk_cloud_id:Number(e.id),bk_cloud_name:e.cloudName,ap_id:e.apId,inner_ip:t?t.inner_ip:""}}))}}),created:function t(){this.handleInit()},mounted:function t(){this.marginLeft=this.initLabelWidth(this.$refs.form);this.initRetryData()},methods:y(y(y({},(0,b.mapMutations)(["setNavTitle"])),(0,b.mapActions)("cloud",["setupProxy","getCloudDetail","getApList","setApUrl"])),{},{handleInit:function t(){var e=this;return(0,n.default)(i.default.mark((function t(){return i.default.wrap((function t(r){while(1){switch(r.prev=r.next){case 0:r.t0=e.type;r.next=r.t0==="create"?3:r.t0==="replace"?5:7;break;case 3:e.setNavTitle(e.$t("安装Proxy"));return r.abrupt("break",7);case 5:e.setNavTitle(e.$t("替换Proxy",{ip:e.innerIp||e.id}));return r.abrupt("break",7);case 7:e.initForm();r.next=10;return e.getCloudBizList();case 10:if(e.apList.length){r.next=13;break}r.next=13;return e.getApList();case 13:e.setApUrl({id:e.apId});case 14:case"end":return r.stop()}}}),t)})))()},initForm:function t(){this.formData={bkCloudSetupInfo:this.setupConfig,retention:-1,osType:"LINUX",port:v.defaultPort,account:"root",bkBizId:""}},initRetryData:function t(){var e=this.$route.params.table;if(e){var r;var a=[];this.isManual=e.some((function(t){return t.is_manual}));e.forEach((function(t){r=t.bk_biz_id;a.push({inner_ip:t.inner_ip,login_ip:t.login_ip,outer_ip:t.outer_ip,auth_type:t.auth_type,prove:true,retention:t.retention||-1})}));this.setupConfig.data=a;this.formData.bkBizId=r;this.installMethodHandle(this.isManual)}},getCloudBizList:function t(){var e=this;return(0,n.default)(i.default.mark((function t(){var r;return i.default.wrap((function t(a){while(1){switch(a.prev=a.next){case 0:if(e.id){a.next=2;break}return a.abrupt("return");case 2:a.next=4;return e.getCloudDetail(e.id);case 4:r=a.sent;e.apId=r.apId;e.cloudName=r.bkCloudName;case 7:case"end":return a.stop()}}}),t)})))()},handleSetup:function t(){var e=this;Promise.all([this.$refs.setupTable.validate(),this.$refs.form.validate()]).then((function(t){var r=t.every((function(t){return!!t}));if(r){var a=e.getFormData();var i=e.type==="create"?"INSTALL_PROXY":"REPLACE_PROXY";e.handleCreateOrReplace(a,i)}}))},getFormData:function t(){var e=this;var r=this.apId;if(this.isManual&&this.apId===-1){var a=this.apList.find((function(t){return t.is_default}));r=a?a.id:""}return this.$refs.setupTable.getData().map((function(t){var a=y(y({},t),{},{retention:e.formData.retention,port:e.formData.port,account:e.formData.account,os_type:e.formData.osType,bk_biz_id:e.formData.bkBizId,bk_cloud_id:e.id,ap_id:r,is_manual:e.isManual});if(!a.login_ip){delete a.login_ip}if(!a.bt_speed_limit){delete a.bt_speed_limit}else{a.bt_speed_limit=Number(a.bt_speed_limit)}a.peer_exchange_switch_for_agent+=0;return a}))},handleCreateOrReplace:function t(e){var r=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"INSTALL_PROXY";return(0,n.default)(i.default.mark((function t(){var n,s,o;return i.default.wrap((function t(i){while(1){switch(i.prev=i.next){case 0:r.loadingSetup=true;n={job_type:a,hosts:e};if(a==="REPLACE_PROXY"){n.replace_host_id=r.replaceHostId}i.next=5;return r.setupProxy({params:n,config:{needRes:true,globalError:false}});case 5:s=i.sent;r.loadingSetup=false;if(s){i.next=9;break}return i.abrupt("return");case 9:if(s.result||s.code===3801018){r.handleFilterIp(s.data)}else{o=s.message?s.message:r.$t("请求出错");r.$bkMessage({message:o,delay:3e3,theme:"error"})}case 10:case"end":return i.stop()}}}),t)})))()},handleCancel:function t(){this.$router.push({name:"cloudManager"})},handleSetupTableChange:function t(e,r){if(r.prop==="inner_ip"){var a=this.$refs.setupTable.getTableData();this.innerIps=a.map((function(t){return t.inner_ip})).join(", ")}},installMethodHandle:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.isManual=e;if(this.isManual){this.setupConfig.header=m.setupManualInfo}else{this.setupConfig.header=m.setupInfo}this.$refs.setupTable.handleInit();this.$refs.setupTable.handleScroll()},handleToggle:function t(){this.showRightPanel=true;this.setupConfig.data=this.getFormData()},handleShowSetting:function t(){this.$refs.setupTable.handleToggleSetting(true)}})};e.default=w},369:function(t,e,r){},494:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.setupManualInfo=e.setupInfo=void 0;var a=r(273);var i=[{label:"内网IP",prop:"inner_ip",tips:window.i18n.t("内网IP提示"),required:true,type:"text",unique:true,errTag:true,iconOffset:10,rules:[{regx:"^((25[0-5]|2[0-4]\\d|[01]?\\d\\d?)\\.){3}(25[0-5]|2[0-4]\\d|[01]?\\d\\d?)$",content:window.i18n.t("IP不符合规范")},{trigger:"blur",content:window.i18n.t("冲突校验",{prop:"IP"}),validator:function t(e,r){if(!e)return true;var a=this.table.data.find((function(t){return t.id===r}));return this.handleValidateUnique(a,{prop:"inner_ip",splitCode:["，"," ","、",","]})}}]},{label:"对外通讯IP",prop:"outer_ip",tips:window.i18n.t("对外通讯IP提示"),type:"text",unique:true,errTag:true,required:true,iconOffset:10,rules:[{regx:"^((25[0-5]|2[0-4]\\d|[01]?\\d\\d?)\\.){3}(25[0-5]|2[0-4]\\d|[01]?\\d\\d?)$",content:window.i18n.t("IP不符合规范")},{trigger:"blur",content:window.i18n.t("冲突校验",{prop:"IP"}),validator:function t(e,r){if(!e)return true;var a=this.table.data.find((function(t){return t.id===r}));return this.handleValidateUnique(a,{prop:"outer_ip",splitCode:["，"," ","、",","]})}}]},{label:"登录IP",prop:"login_ip",tips:window.i18n.t("登录IP提示"),type:"text",required:false,unique:true,errTag:true,placeholder:window.i18n.t("留空默认为内网IP"),iconOffset:10,rules:[{regx:"^((25[0-5]|2[0-4]\\d|[01]?\\d\\d?)\\.){3}(25[0-5]|2[0-4]\\d|[01]?\\d\\d?)$",content:window.i18n.t("IP不符合规范")},{trigger:"blur",content:window.i18n.t("冲突校验",{prop:"IP"}),validator:function t(e,r){if(!e)return true;var a=this.table.data.find((function(t){return t.id===r}));return this.handleValidateUnique(a,{prop:"login_ip",splitCode:["，"," ","、",","]})}}]},{label:"认证方式",prop:"auth_type",type:"select",required:true,default:"PASSWORD",iconOffset:10,getOptions:function t(e){return e.os_type==="WINDOWS"?a.authentication.filter((function(t){return t.id!=="KEY"})):a.authentication},handleValueChange:function t(e){var r=a.authentication.find((function(t){return t.id===e.auth_type}))||{};e.prove=r.default||""}},{label:"密码密钥",required:true,prop:"prove",type:"password",subTitle:window.i18n.t("仅对密码认证生效"),iconOffset:10,getReadonly:function t(e){return e.auth_type&&e.auth_type==="TJJ_PASSWORD"},getCurrentType:function t(e){var r=a.authentication.find((function(t){return t.id===e.auth_type}))||{};return r.type||"text"}},{label:"BT传输加速",prop:"peer_exchange_switch_for_agent",type:"switcher",default:true,required:false,width:115},{label:"传输限速",prop:"bt_speed_limit",type:"text",required:false,appendSlot:"MB/s",iconOffset:45,width:160,rules:[{regx:"^[1-9]\\d*$",content:window.i18n.t("整数最小值校验提示",{min:1})}]},{label:"",prop:"",type:"operate",width:50}];e.setupInfo=i;var n=[{label:"内网IP",prop:"inner_ip",tips:window.i18n.t("内网IP提示"),required:true,type:"text",unique:true,errTag:true,iconOffset:10,rules:[{regx:"^((25[0-5]|2[0-4]\\d|[01]?\\d\\d?)\\.){3}(25[0-5]|2[0-4]\\d|[01]?\\d\\d?)$",content:window.i18n.t("IP不符合规范")},{trigger:"blur",content:window.i18n.t("冲突校验",{prop:"IP"}),validator:function t(e,r){if(!e)return true;var a=this.table.data.find((function(t){return t.id===r}));return this.handleValidateUnique(a,{prop:"inner_ip",splitCode:["，"," ","、",","]})}}]},{label:"对外通讯IP",prop:"outer_ip",tips:window.i18n.t("对外通讯IP提示"),type:"text",unique:true,errTag:true,required:true,iconOffset:10,rules:[{regx:"^((25[0-5]|2[0-4]\\d|[01]?\\d\\d?)\\.){3}(25[0-5]|2[0-4]\\d|[01]?\\d\\d?)$",content:window.i18n.t("IP不符合规范")},{trigger:"blur",content:window.i18n.t("冲突校验",{prop:"IP"}),validator:function t(e,r){if(!e)return true;var a=this.table.data.find((function(t){return t.id===r}));return this.handleValidateUnique(a,{prop:"outer_ip",splitCode:["，"," ","、",","]})}}]},{label:"BT传输加速",prop:"peer_exchange_switch_for_agent",type:"switcher",default:true,required:false,width:115},{label:"传输限速",prop:"bt_speed_limit",type:"text",required:false,appendSlot:"MB/s",iconOffset:45,width:160,rules:[{regx:"^[1-9]\\d*$",content:window.i18n.t("整数最小值校验提示",{min:1})}]},{label:"",prop:"",type:"operate",width:50,local:true}];e.setupManualInfo=n},495:function(t,e,r){"use strict";var a=r(369);var i=r.n(a);var n=i.a},555:function(t,e,r){"use strict";r.d(e,"a",(function(){return a}));r.d(e,"b",(function(){return i}));var a=function(){var t=this;var e=t.$createElement;var r=t._self._c||e;return r("article",{staticClass:"setup-cloud mt15 pb20"},[r("div",{staticClass:"setup-cloud-left"},[r("section",{staticClass:"left-form"},[r("tips",{staticClass:"mb20",scopedSlots:t._u([{key:"default",fn:function(){return[r("ul",[t.type==="replace"?t._l(t.topTips,(function(e,a){return r("li",{key:a,staticClass:"tips-content-item"},[t._v("\n                "+t._s(e)+"\n              ")])})):t._e(),t._v(" "),r("li",{staticClass:"tips-content-item"},[t._v("\n              "+t._s(t.$t("安装要求tips",{type:"Proxy"}))+"\n              "),r("bk-link",{staticClass:"tips-link",attrs:{theme:"primary"},on:{click:t.handleToggle}},[t._v(t._s(t.$t("安装要求")))]),t._v("\n              "+t._s(t.$t("表格展示设置tips"))+"\n              "),r("bk-link",{staticClass:"tips-link",attrs:{theme:"primary"},on:{click:t.handleShowSetting}},[t._v(t._s(t.$t("表格展示设置")))])],1)],2)]},proxy:true}])}),t._v(" "),r("bk-form",{ref:"form",attrs:{"label-width":t.marginLeft,model:t.formData,rules:t.rules}},[r("install-method",{attrs:{"is-manual":t.isManual},on:{change:t.installMethodHandle}}),t._v(" "),r("bk-form-item",{attrs:{label:t.$t("安装信息")}},[t.filterList.length&&t.showFilterTips?r("filter-ip-tips",{staticClass:"mb15 filter-tips",on:{click:t.handleShowDetail}}):t._e(),t._v(" "),r("setup-table",{key:t.net.active,ref:"setupTable",class:{"cloud-setup-table":t.isManual},attrs:{"local-mark":"proxy_setup","setup-info":t.formData.bkCloudSetupInfo},on:{change:t.handleSetupTableChange}})],1),t._v(" "),r("bk-form-item",{attrs:{"error-display-type":"normal",label:t.$t("密码安全"),required:""}},[r("bk-radio-group",{staticClass:"content-basic",model:{value:t.formData.retention,callback:function(e){t.$set(t.formData,"retention",e)},expression:"formData.retention"}},[r("bk-radio",{attrs:{value:1}},[t._v(t._s(t.$t("保存1天")))]),t._v(" "),r("bk-radio",{staticClass:"ml35",attrs:{value:-1}},[t._v(t._s(t.$t("长期保存")))])],1)],1),t._v(" "),r("bk-form-item",{attrs:{"error-display-type":"normal",label:t.$t("操作系统"),property:"osType",required:""}},[r("bk-select",{directives:[{name:"bk-tooltips",rawName:"v-bk-tooltips.right",value:t.$t("仅支持Linux64位操作系统"),expression:"$t('仅支持Linux64位操作系统')",modifiers:{right:true}}],staticClass:"content-basic",attrs:{placeholder:t.$t("请选择"),clearable:false,disabled:""},model:{value:t.formData.osType,callback:function(e){t.$set(t.formData,"osType",e)},expression:"formData.osType"}},[r("bk-option",{attrs:{id:"LINUX",name:"Linux(64位)"}})],1)],1),t._v(" "),!t.isManual?[r("bk-form-item",{attrs:{"error-display-type":"normal",label:t.$t("登录端口"),property:"port",required:""}},[r("bk-input",{staticClass:"content-basic",attrs:{placeholder:t.$t("请输入")},model:{value:t.formData.port,callback:function(e){t.$set(t.formData,"port",e)},expression:"formData.port"}})],1),t._v(" "),r("bk-form-item",{attrs:{"error-display-type":"normal",label:t.$t("登录账号"),property:"account",required:""}},[r("bk-input",{staticClass:"content-basic",attrs:{placeholder:t.$t("请选择")},model:{value:t.formData.account,callback:function(e){t.$set(t.formData,"account",e)},expression:"formData.account"}})],1)]:t._e(),t._v(" "),r("bk-form-item",{attrs:{"error-display-type":"normal",label:t.$t("归属业务"),property:"bkBizId",required:""}},[r("bk-biz-select",{staticClass:"content-basic",attrs:{placeholder:t.$t("待选择"),"show-select-all":false,multiple:false,"auto-update-storage":false},model:{value:t.formData.bkBizId,callback:function(e){t.$set(t.formData,"bkBizId",e)},expression:"formData.bkBizId"}})],1)],2)],1),t._v(" "),r("section",{staticClass:"left-footer"},[r("bk-button",{style:{marginLeft:t.marginLeft+"px"},attrs:{theme:"primary","ext-cls":"nodeman-primary-btn",loading:t.loadingSetup},on:{click:t.handleSetup}},[t._v("\n        "+t._s(t.saveBtnText)+"\n      ")]),t._v(" "),r("bk-button",{staticClass:"nodeman-cancel-btn ml5",on:{click:t.handleCancel}},[t._v(t._s(t.$t("取消")))])],1)]),t._v(" "),r("div",{staticClass:"setup-cloud-right",class:{"right-panel":t.showRightPanel}},[r("right-panel",{attrs:{"host-type":"Proxy","host-list":t.hostList},model:{value:t.showRightPanel,callback:function(e){t.showRightPanel=e},expression:"showRightPanel"}})],1),t._v(" "),[r("filter-dialog",{attrs:{list:t.filterList,title:t.$t("忽略详情")},model:{value:t.showFilterDialog,callback:function(e){t.showFilterDialog=e},expression:"showFilterDialog"}})]],2)};var i=[]}}]);